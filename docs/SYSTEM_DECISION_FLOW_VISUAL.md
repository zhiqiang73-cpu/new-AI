# 🎯 系统决策流程图 - 可视化思维树

> **可视化版本** - 用图形化方式展示每个决策点的上下级关系

---

## 📊 主流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    系统主循环 (每10秒)                           │
│                    run_agent_loop()                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  1. 获取K线数据 (1m/15m/8h/1w)          │
        │  2. 获取订单簿数据                       │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  市场分析模块                            │
        │  analyze_market()                       │
        └─────────────────────────────────────────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        │                                           │
        ▼                                           ▼
┌───────────────┐                          ┌───────────────┐
│  技术指标分析  │                          │  支撑阻力发现  │
│  RSI/MACD/EMA │                          │  多周期评分   │
└───────────────┘                          └───────────────┘
        │                                           │
        └─────────────────┬─────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────────┐
        │  多周期趋势分析                         │
        │  macro_trend / micro_trend             │
        └─────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────────┐
        │  市场状态识别                            │
        │  TRENDING / RANGING / VOLATILE         │
        └─────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────────┐
        │  突破检测                                │
        │  breakout_support / breakout_resistance│
        └─────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────────┐
        │  输出: market字典                        │
        │  - current_price                        │
        │  - best_support / best_resistance       │
        │  - macro_trend / micro_trend            │
        │  - regime / breakout信号                │
        └─────────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
        ▼                                   ▼
┌───────────────┐                  ┌───────────────┐
│  出场检查      │                  │  入场检查      │
│ check_exit_all│                  │ should_enter  │
└───────────────┘                  └───────────────┘
        │                                   │
        ▼                                   ▼
┌───────────────┐                  ┌───────────────┐
│  执行平仓      │                  │  执行开仓      │
│execute_exit   │                  │execute_entry  │
└───────────────┘                  └───────────────┘
        │                                   │
        └─────────────────┬─────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────────┐
        │  学习反馈更新                             │
        │  - 特征权重学习                           │
        │  - 决策特征学习                           │
        │  - 策略参数学习                           │
        │  - 出场时机学习                           │
        └─────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────────┐
        │  等待10秒，进入下一轮循环                 │
        └─────────────────────────────────────────┘
```

---

## 🎯 入场决策详细流程图

```
                    【入场决策树】
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  启动冷却检查 (3分钟)                │
        └─────────────────────────────────────┘
                    │
                    ▼ (通过)
        ┌─────────────────────────────────────┐
        │  仓位数量检查 (MAX=3)                │
        └─────────────────────────────────────┘
                    │
                    ▼ (通过)
        ┌─────────────────────────────────────┐
        │  风险控制检查                        │
        │  - 单日亏损 < 5%                     │
        │  - 最大回撤 < 10%                    │
        │  - 连续亏损 < 3次                    │
        └─────────────────────────────────────┘
                    │
                    ▼ (通过)
        ┌─────────────────────────────────────┐
        │  冷却时间检查 (15秒)                 │
        └─────────────────────────────────────┘
                    │
                    ▼ (通过)
        ┌─────────────────────────────────────┐
        │  市场分析 (analyze_market)          │
        │  ↓                                  │
        │  输出: market字典                    │
        └─────────────────────────────────────┘
                    │
                    ▼
        ┌─────────────────────────────────────┐
        │  入场评分 (_score_entry)            │
        │  ↓                                  │
        │  计算: long_score, short_score      │
        └─────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│  突破信号检查  │      │  评分阈值检查  │
│  (优先级最高)  │      │  score >= 55  │
└───────────────┘      └───────────────┘
        │                       │
        │ (有)                  │ (通过)
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│  直接入场       │      │  同分处理      │
│  (跳过其他检查) │      │  (long=short)  │
└───────────────┘      └───────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  优先级1: 微观趋势     │
                    │  优先级2: 分数差距     │
                    │  优先级3: 宏观趋势     │
                    └───────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  分批建仓检查           │
                    │  - 时间间隔 > 3分钟    │
                    │  - 价格差距 > 0.2%     │
                    └───────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  输出: signal字典       │
                    │  - direction          │
                    │  - strength           │
                    │  - reason             │
                    └───────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  执行入场              │
                    │  execute_entry()      │
                    └───────────────────────┘
```

---

## 🎯 入场评分详细分解

```
                    【入场评分系统】
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  初始化: long_score=0, short_score=0 │
        └─────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
        ▼                                   ▼
┌───────────────┐                  ┌───────────────┐
│  突破信号      │                  │  趋势评分      │
│  +30~50分     │                  │  +35分        │
│  (最高优先级)  │                  │  (micro+macro)│
└───────────────┘                  └───────────────┘
        │                                   │
        └─────────────────┬─────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  支撑阻力位评分                       │
        │  +40分 (距离<0.2%)                   │
        │  +25分 (距离<0.5%)                   │
        │  -18分 (反向惩罚)                     │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  技术指标评分                         │
        │  RSI: +8分                           │
        │  MACD: +8分                          │
        │  1m动量: +9分                        │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  K线形态评分                         │
        │  +12分 (根据形态)                    │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  决策特征学习评分                     │
        │  +0~20分 (基于历史学习)              │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  市场偏向性调整                       │
        │  ×0.75~1.0 (逆势惩罚)                │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  市场状态系数                         │
        │  ×0.7~1.2 (regime调整)              │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  输出: long_score, short_score      │
        │  范围: 0-100分                      │
        └─────────────────────────────────────┘
```

---

## 🎯 出场决策详细流程图

```
                    【出场决策树】
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  遍历所有持仓 (positions)            │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  对每个持仓调用                      │
        │  ExitManager.evaluate()             │
        └─────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
        ▼                                   ▼
┌───────────────┐                  ┌───────────────┐
│  基础止损止盈  │                  │  最大亏损检查  │
│  price<=SL    │                  │  pnl<=-1.0%   │
│  price>=TP    │                  └───────────────┘
└───────────────┘                          │
        │                                   │
        │ (未触发)                           │ (未触发)
        └─────────────────┬─────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  支撑阻力动态出场                     │
        │  (优先级最高)                        │
        │  - 触及阻力后回落0.05%               │
        │  - 触及支撑后反弹0.05%               │
        └─────────────────────────────────────┘
                          │
                          ▼ (未触发)
        ┌─────────────────────────────────────┐
        │  利润锁定检查                         │
        │  max_pnl>=0.6% 且                    │
        │  pnl<=max_pnl-drop                   │
        └─────────────────────────────────────┘
                          │
                          ▼ (未触发)
        ┌─────────────────────────────────────┐
        │  机会成本切换检查                     │
        │  (持仓>=15分钟)                      │
        │  - 新信号分数>=阈值+25分             │
        │  - 新信号分数>=70分                  │
        │  - 当前亏损>=-0.1%                   │
        │  - 当前盈利<0.8%                     │
        └─────────────────────────────────────┘
                          │
                          ▼ (未触发)
        ┌─────────────────────────────────────┐
        │  分批止盈检查                         │
        │  pnl>0.6% 且 score<50                │
        │  → 平50%                             │
        └─────────────────────────────────────┘
                          │
                          ▼ (未触发)
        ┌─────────────────────────────────────┐
        │  时间成本检查                         │
        │  持仓>=45分钟 且 盈利<0.8%           │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  输出: ExitDecision 或 None         │
        │  - reason: 平仓原因                  │
        │  - fraction: 平仓比例               │
        └─────────────────────────────────────┘
```

---

## 🔄 学习反馈循环

```
                    【学习反馈系统】
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  交易完成 (execute_exit_position)   │
        │  - 计算盈亏 (pnl_percent)           │
        │  - 计算出场时机质量                   │
        └─────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
        ▼                                   ▼
┌───────────────┐                  ┌───────────────┐
│  决策特征学习   │                  │  特征权重学习   │
│DecisionFeature│                  │LevelFinder    │
│Learner.update │                  │update_weights │
└───────────────┘                  └───────────────┘
        │                                   │
        └─────────────────┬─────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
        ▼                                   ▼
┌───────────────┐                  ┌───────────────┐
│  策略参数学习   │                  │  出场时机学习   │
│StrategyParam │                  │ExitTiming     │
│Learner.update│                  │Learner.update │
└───────────────┘                  └───────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  更新参数到各个模块                    │
        │  - ExitManager.update_params()       │
        │  - StopLossTakeProfit.update_params() │
        │  - LevelFinder权重更新                │
        └─────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  影响下一笔交易的决策                 │
        │  (形成学习循环)                       │
        └─────────────────────────────────────┘
```

---

## ⚠️ 关键问题点标注

### 🔴 高风险问题点

```
1. 【阈值硬编码】agent.py:108
   effective_threshold = 55 (固定)
   → 应该使用 DynamicThresholdOptimizer
   → 影响: 入场质量

2. 【多周期权重】agent.py:152-167
   权重动态调整但基础值固定
   → 可能不适合所有市场状态
   → 影响: 趋势判断准确性

3. 【支撑阻力间距】agent.py:566
   min_gap_pct = 0.3%
   → 过严格可能导致无有效价位
   → 影响: 入场机会

4. 【出场阈值】exit_manager.py:85-88
   touch_pct = 0.03%, pullback_pct = 0.05%
   → 可能被噪音触发
   → 影响: 出场时机
```

### 🟡 中风险问题点

```
5. 【机会成本切换】exit_manager.py:223-260
   条件较严格 (分数差>=25分)
   → 可能错过切换机会
   → 影响: 持仓效率

6. 【学习数据积累】多个学习模块
   初期数据不足时效果有限
   → 需要足够交易数据
   → 影响: 学习效果

7. 【仓位计算】agent.py:373-399
   杠杆和仓位大小计算复杂
   → 可能不合理
   → 影响: 盈亏幅度
```

---

## 📊 数据流向图

```
┌──────────────┐
│  Binance API │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  K线数据      │──→ analyze_market()
└──────┬───────┘      │
       │              │
       ▼              ▼
┌──────────────┐  ┌──────────────┐
│  技术指标      │  │  支撑阻力位   │
└──────┬───────┘  └──────┬───────┘
       │                 │
       └────────┬────────┘
                │
                ▼
        ┌──────────────┐
        │  market字典   │
        └──────┬───────┘
               │
        ┌──────┴───────┐
        │              │
        ▼              ▼
┌──────────────┐  ┌──────────────┐
│  should_enter│  │check_exit_all│
└──────┬───────┘  └──────┬───────┘
       │                 │
       ▼                 ▼
┌──────────────┐  ┌──────────────┐
│execute_entry │  │execute_exit  │
└──────┬───────┘  └──────┬───────┘
       │                 │
       └────────┬────────┘
                │
                ▼
        ┌──────────────┐
        │  交易结果      │
        │  (pnl, etc)  │
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │  学习更新      │
        │  (weights)   │
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │  影响下次决策  │
        └──────────────┘
```

---

## 🎯 决策影响链分析

### 入场决策影响链

```
市场数据质量
    ↓
技术指标准确性
    ↓
支撑阻力位识别准确性
    ↓
多周期趋势判断准确性
    ↓
入场评分准确性
    ↓
阈值设置合理性
    ↓
入场决策质量
    ↓
入场位置和时机
    ↓
初始盈亏比
    ↓
最终盈亏
```

### 出场决策影响链

```
持仓状态
    ↓
当前盈亏
    ↓
市场信号变化
    ↓
支撑阻力位变化
    ↓
出场条件检查
    ↓
出场时机选择
    ↓
出场价格
    ↓
最终盈亏
    ↓
学习反馈
    ↓
影响下次决策
```

---

**可视化完成时间**: 2026-01-15  
**配合文档**: SYSTEM_LOGIC_TREE_COMPLETE.md  
**用途**: 快速理解系统决策流程和问题点


